<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">FMEA Reports</h1>
        <nav class="mb-3">
            <a href="/" class="btn btn-primary me-2">Data Entry Form</a>
            <a href="/dashboard" class="btn btn-secondary">Dashboard</a>
        </nav>
        <div class="mb-3">
            <button onclick="exportToPDF()" class="btn btn-danger me-2">Export to PDF</button>
            <button onclick="exportToCSV()" class="btn btn-success">Export to Excel (CSV)</button>
        </div>
        <h2>Failure Modes Table</h2>
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>Failure Mode</th>
                    <th>S</th>
                    <th>O</th>
                    <th>D</th>
                    <th>RPN</th>
                </tr>
            </thead>
            <tbody>
            {% for mode in data %}
            <tr>
                <td>{{ mode['Failure Mode'] }}</td>
                <td>{{ mode['S'] }}</td>
                <td>{{ mode['O'] }}</td>
                <td>{{ mode['D'] }}</td>
                <td>{{ mode['RPN'] }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    <h2>Statistical Summary</h2>
    <p>Average: {{ stats['average'] }}</p>
    <p>Maximum: {{ stats['max'] }}</p>
    <p>Minimum: {{ stats['min'] }}</p>
    <p>Number of High Risks (>60): {{ stats['high_risk'] }}</p>
    <script>
        // Create a JSON-safe representation of the data for JS
        const data = {{ data | tojson }} || [];

        // Normalize fields to friendly names (in case keys contain spaces)
        const normalizedData = data.map(item => ({
            name: item['Failure Mode'] || item.failure_mode || '',
            s: item.S ?? item.s ?? item['S'] ?? 0,
            o: item.O ?? item.o ?? item['O'] ?? 0,
            d: item.D ?? item.d ?? item['D'] ?? 0,
            rpn: item.RPN ?? item.rpn ?? item['RPN'] ?? 0
        }));

        function exportToCSV() {
            let csv = 'Failure Mode,S,O,D,RPN\n';
            normalizedData.forEach(row => {
                csv += `${row.name},${row.s},${row.o},${row.d},${row.rpn}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fmea_report.csv';
            a.click();
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            doc.setFontSize(16);
            doc.text('FMEA Report', 105, 20, { align: 'center' });
            let y = 30;
            normalizedData.forEach(row => {
                doc.setFontSize(12);
                doc.text(`${row.name} - S:${row.s}, O:${row.o}, D:${row.d}, RPN:${row.rpn}`, 10, y);
                y += 10;
                if (y > 280) {
                    doc.addPage();
                    y = 10;
                }
            });
            doc.save('fmea_report.pdf');
        }
    </script>
</body>
</html>